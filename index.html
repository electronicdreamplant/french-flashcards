<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>French Vocab Flashcards</title>
  <style>
    :root{
      --page:#f7f8fa; --ink:#111; --muted:#555; --accent:#0b57d0;
      --card:#ffe36d; /* yellow card */
      --card-border:#e2c44f;
    }
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--page);color:var(--ink)}

    /* Layout: clean sidebar on the left, card high on the page */
    .app{display:grid;grid-template-columns:360px 1fr;gap:0;min-height:100vh}
    @media (max-width:980px){.app{grid-template-columns:1fr}}

    /* Sidebar */
    .side{background:#fff;border-right:1px solid #e8e8e8;padding:18px 18px 24px;position:sticky;top:0;height:100vh;overflow:auto}
    .side h1{font-size:22px;margin:0 0 14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .full{grid-column:1 / -1}
    .field label{display:block;font-size:13px;color:#666;margin:0 0 6px}
    input[type="text"], select{width:100%;padding:10px 12px;border:1px solid #cfcfcf;border-radius:6px;background:#fff;color:#111;font-size:15px}
    .buttons{display:flex;gap:8px}
    .btn{appearance:none;border:1px solid #cfcfcf;background:#fff;color:#111;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .hint{font-size:12px;color:#777;margin-top:6px}

    /* Stage */
    .stageWrap{padding:22px}
    .stats{font-size:13px;color:#666;text-align:right;margin-bottom:10px}
    .stage{display:flex;justify-content:center;align-items:flex-start}

    /* Card */
    .card{width:min(900px,92vw);min-height:260px;background:var(--card);border:2px solid var(--card-border);border-radius:18px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:18px;position:relative}
    .meta{position:absolute;top:12px;left:16px;font-size:12px;color:#333}
    .front .term{font-size:50px;line-height:1.1;font-weight:800;margin-top:28px}
    .front .article{margin-right:.4rem;opacity:.9}
    .pron{font-size:14px;color:#333;margin-top:6px}
    .tags{margin-top:10px}
    .back .answer{font-size:38px;font-weight:800;margin-top:28px}
    .sentence{font-size:18px;margin-top:8px;color:#222}
    .notes{margin-top:6px;color:#333;font-size:14px}

    .actions{position:sticky;bottom:0;display:flex;gap:8px;justify-content:center;margin-top:14px;padding:10px 0;background:transparent}
    .btn.again{background:#fbe3e3;border-color:#f0bcbc}
    .btn.good{background:#e6f4ea;border-color:#b9e0c3}
    .btn.easy{background:#e8f0fe;border-color:#c7d3fe}

    .empty{color:#666;text-align:center;margin-top:12px}

    /* Segmented switch */
    .seg{display:inline-flex;border:1px solid #cfcfcf;border-radius:8px;overflow:hidden}
    .seg button{border:0;background:#fff;padding:8px 12px;font-size:14px;cursor:pointer}
    .seg button.active{background:#111;color:#fff}

    /* Flip handling */
    .back{display:none}
    .card.flipped .front{display:none}
    .card.flipped .back{display:block}
  </style>
</head>
<body>
  <div class="app">
    <aside class="side">
      <h1>French Vocab Flashcards</h1>
      <div class="grid">
        <div class="field full">
          <label>Data source (CSV URL)</label>
          <input id="csvUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv" />
          <div class="buttons" style="margin-top:8px">
            <button class="btn primary" id="loadBtn">Load</button>
            <button class="btn" id="resetBtn" title="Clear progress for this source">Reset progress</button>
          </div>
          <div class="hint">Press Enter or Load. Headers: id, deck, lesson, article, french, english, sentence, pron, tags, notes, <strong>labels</strong></div>
        </div>

        <div class="field">
          <label>Direction</label>
          <div class="seg" id="dirSeg">
            <button data-dir="fr-en" class="active">FR → EN</button>
            <button data-dir="en-fr">EN → FR</button>
          </div>
        </div>
        <div class="field">
          <label>Study</label>
          <select id="studyMode"><option value="due">Due today</option><option value="all">All filtered</option></select>
        </div>

        <div class="field">
          <label>Deck</label>
          <select id="deckFilter"><option value="">All decks</option></select>
        </div>
        <div class="field">
          <label>Lesson</label>
          <select id="lessonFilter"><option value="">All</option></select>
        </div>

        <div class="field full">
          <label>Search (French / English / sentence / tags)</label>
          <input id="search" type="text" placeholder="e.g. pain, breakfast, OU-L2" />
        </div>

        <div class="field">
          <label>Shuffle</label>
          <select id="shuffle"><option value="yes">Yes</option><option value="no">No</option></select>
        </div>
      </div>
    </aside>

    <main class="stageWrap">
      <div class="stats" id="stats">Loading…</div>
      <div class="stage">
        <div class="card" id="card" style="display:none">
          <div class="meta" id="meta"></div>

          <div class="front" id="front">
            <div class="term"><span class="article" id="article"></span><span id="term"></span></div>
            <div class="pron" id="pron"></div>
            <div class="tags" id="tags"></div>
          </div>

          <div class="back" id="back">
            <div class="answer" id="answer"></div>
            <div class="sentence" id="sentence"></div>
            <div class="notes" id="notes"></div>
          </div>
        </div>
      </div>

      <div class="actions" id="actions" style="display:none">
        <button class="btn again" id="againBtn" title="1 or A">Again</button>
        <button class="btn good" id="goodBtn" title="2 or G">Good</button>
        <button class="btn easy" id="easyBtn" title="3 or E">Easy</button>
        <button class="btn" id="flipBtn" title="Space">Flip</button>
      </div>

      <div class="empty" id="empty">No cards match your filters (or nothing due). Try Study → "All filtered".</div>
    </main>
  </div>

  <script>
  // ----------------- state -----------------
  const d = id => document.getElementById(id);
  const state = { src:"", rows:[], queue:[], idx:0, today: new Date().toISOString().slice(0,10), progress:{}, direction:'fr-en' };

  // ----------------- csv -----------------
  function parseCSV(text){
    const out=[], row=[], pushRow=()=>{ out.push(row.splice(0)); };
    let i=0, field='', inQ=false;
    const pushField=()=>{ row.push(field); field=''; };
    while(i<text.length){
      const c=text[i];
      if(inQ){ if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i+=2; continue;} inQ=false; i++; } else { field+=c; i++; } }
      else { if(c==='"'){ inQ=true; i++; } else if(c===','){ pushField(); i++; } else if(c==='\n' || c==='\r'){ pushField(); if(row.length) pushRow(); i++; if(c==='\r' && text[i]==='\n') i++; } else { field+=c; i++; } }
    }
    if(field!==''||row.length){ pushField(); pushRow(); }
    return out;
  }
  function mapHeaders(rows){
    if(!rows.length) return [];
    const header = rows[0].map(h=>h.trim().toLowerCase());
    const idx = n => header.indexOf(n);
    return rows.slice(1).map((r,ix)=>({
      id: r[idx('id')] || String(ix+1),
      deck: (r[idx('deck')]||'').trim(),
      lesson: (r[idx('lesson')]||'').trim(),
      article: (r[idx('article')]||'').trim(),
      french: (r[idx('french')]||'').trim(),
      english: (r[idx('english')]||'').trim(),
      sentence: (r[idx('sentence')]||'').trim(),
      pron: (r[idx('pron')]||'').trim(),
      tags: (r[idx('tags')]||'').trim(),
      notes: (r[idx('notes')]||'').trim(),
      labels: (r[idx('labels')]||'').trim(),
    })).filter(x=>x.french||x.english);
  }

  // ----------------- storage -----------------
  const key = ()=> 'flashcards::'+state.src;
  const saveProgress = ()=> localStorage.setItem(key(), JSON.stringify(state.progress));
  const loadProgress = ()=> state.progress = JSON.parse(localStorage.getItem(key())||'{}');

  // ----------------- scheduling -----------------
  const SCHED={1:0,2:1,3:2,4:4,5:7};
  const nextDate=(from,days)=>{const dt=new Date(from); dt.setDate(dt.getDate()+days); return dt.toISOString().slice(0,10)};
  const ensure=(id)=>{ if(!state.progress[id]) state.progress[id]={box:1,due:state.today}; };
  function grade(grade){
    const c=state.queue[state.idx]; if(!c) return; ensure(c.id);
    const p=state.progress[c.id];
    if(grade==='again') p.box=1; if(grade==='good') p.box=Math.min(5,p.box+1); if(grade==='easy') p.box=Math.min(5,p.box+2);
    p.due = nextDate(state.today,SCHED[p.box]); saveProgress();
    next(1);
  }

  // ----------------- filtering -----------------
  function filter(){
    const deck=d('deckFilter').value.toLowerCase();
    const lesson=d('lessonFilter').value.toLowerCase();
    const q=d('search').value.toLowerCase();
    let rows=state.rows.filter(r=>(!deck||r.deck.toLowerCase()===deck)&&(!lesson||r.lesson.toLowerCase()===lesson)&&(!q||(r.french+" "+r.english+" "+r.sentence+" "+r.tags).toLowerCase().includes(q)));
    loadProgress();
    if(d('studyMode').value==='due') rows=rows.filter(r=>{ensure(r.id); return state.progress[r.id].due<=state.today;});
    if(d('shuffle').value==='yes') for(let i=rows.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [rows[i],rows[j]]=[rows[j],rows[i]]}
    state.queue=rows; state.idx=0; stats(); render();
  }
  function stats(){ d('stats').textContent = `${state.queue.length} cards · ${d('studyMode').value==='due'?'due today':'in view'}`; }

  // ----------------- render -----------------
  function render(){
    const card=d('card'), actions=d('actions'), empty=d('empty');
    const c=state.queue[state.idx];
    if(!c){ card.style.display='none'; actions.style.display='none'; empty.style.display='block'; return; }
    empty.style.display='none'; actions.style.display='flex'; card.style.display='block';

    const p=state.progress[c.id]||{box:1,due:state.today};
    const metaText = c.labels || '';
    d('meta').textContent = metaText;

    const fr = (c.article?c.article+" ":"") + (c.french||"");
    if(state.direction==='fr-en'){
      d('article').textContent=c.article||'';
      d('term').textContent=c.french||'';
      d('pron').textContent=c.pron||'';
      d('answer').textContent=c.english||'';
    } else {
      d('article').textContent='';
      d('term').textContent=c.english||'';
      d('pron').textContent='';
      d('answer').textContent=fr.trim();
    }

    d('sentence').textContent=c.sentence||'';
    d('notes').textContent=c.notes||'';
    d('tags').innerHTML=(c.tags||'').split(/[;, ]+/).filter(Boolean).slice(0,6).map(t=>`<span class="pill">${t}</span>`).join(' ');
  }
  const next=(step)=>{ if(!state.queue.length) return; state.idx=(state.idx+(step||1)+state.queue.length)%state.queue.length; render(); };

  // ----------------- load -----------------
  async function loadCsv(url){
    state.src=url.trim(); if(!state.src){ alert('Please enter a CSV URL'); return; }
    try{
      const res=await fetch(state.src,{headers:{'Cache-Control':'no-cache'}});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const txt=await res.text();
      state.rows=mapHeaders(parseCSV(txt));
      localStorage.setItem('flashcards::lastSrc', state.src);
      populate(); filter();
    }catch(e){ alert('Load failed: '+e.message); }
  }
  function populate(){
    const decks=[...new Set(state.rows.map(r=>r.deck).filter(Boolean))].sort();
    const lessons=[...new Set(state.rows.map(r=>r.lesson).filter(Boolean))].sort((a,b)=>isNaN(a)-isNaN(b)||a-b);
    d('deckFilter').innerHTML='<option value="">All decks</option>'+decks.map(x=>`<option>${x}</option>`).join('');
    d('lessonFilter').innerHTML='<option value="">All</option>'+lessons.map(x=>`<option>${x}</option>`).join('');
  }

  // ----------------- events -----------------
  d('loadBtn').addEventListener('click',()=>loadCsv(d('csvUrl').value));
  d('csvUrl').addEventListener('keydown',e=>{ if(e.key==='Enter') loadCsv(d('csvUrl').value); });
  d('resetBtn').addEventListener('click',()=>{ if(confirm('Reset progress for this source?')){ localStorage.removeItem('flashcards::'+state.src); state.progress={}; filter(); } });
  ['deckFilter','lessonFilter','studyMode','shuffle'].forEach(id=> d(id).addEventListener('change',filter));
  d('search').addEventListener('input',filter);
  d('flipBtn').addEventListener('click',()=>{ d('card').classList.toggle('flipped'); });
  d('againBtn').addEventListener('click',()=>grade('again'));
  d('goodBtn').addEventListener('click',()=>grade('good'));
  d('easyBtn').addEventListener('click',()=>grade('easy'));
  window.addEventListener('keydown',e=>{
    if(e.key===' ') { e.preventDefault(); d('card').classList.toggle('flipped'); }
    if(e.key==='ArrowRight') next(1);
    if(e.key==='ArrowLeft') next(-1);
    if(e.key==='1'||e.key.toLowerCase()==='a') grade('again');
    if(e.key==='2'||e.key.toLowerCase()==='g') grade('good');
    if(e.key==='3'||e.key.toLowerCase()==='e') grade('easy');
  });
  document.getElementById('dirSeg').addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return; [...document.querySelectorAll('#dirSeg button')].forEach(x=>x.classList.remove('active')); b.classList.add('active'); state.direction=b.dataset.dir; render();
  });

  // ----------------- startup -----------------
  document.addEventListener('DOMContentLoaded',()=>{
    const saved=localStorage.getItem('flashcards::lastSrc');
    if(saved) d('csvUrl').value=saved;
    if(d('csvUrl').value) loadCsv(d('csvUrl').value);
  });

  // Demo data intentionally removed (per request)
  </script>
</body>
</html>
